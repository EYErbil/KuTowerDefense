package com.ku.towerdefense.controller;

import com.ku.towerdefense.model.map.GameMap;
import com.ku.towerdefense.ui.MainMenuScreen;
import javafx.animation.AnimationTimer;
import javafx.application.Platform;
import javafx.geometry.Insets;
import javafx.geometry.Pos;
import javafx.scene.Scene;
import javafx.scene.canvas.Canvas;
import javafx.scene.canvas.GraphicsContext;
import javafx.scene.control.Alert;
import javafx.scene.control.Button;
import javafx.scene.control.Label;
import javafx.scene.layout.BorderPane;
import javafx.scene.layout.HBox;
import javafx.scene.layout.VBox;
import javafx.scene.paint.Color;
import javafx.stage.FileChooser;
import javafx.stage.Stage;

import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.ObjectInputStream;
import java.io.ObjectOutputStream;
import java.util.concurrent.atomic.AtomicReference;

/**
 * Screen for playing the tower defense game.
 */
public class GamePlayScreen extends BorderPane {

    private final Stage primaryStage;
    private GameController gameController;
    private Canvas gameCanvas;
    private AnimationTimer gameLoop;
    private Label goldLabel;
    private Label livesLabel;
    private Label waveLabel;
    private long lastUpdateTime;

    /**
     * Creates a new game play screen.
     *
     * @param primaryStage the primary stage
     * @param gameMap the game map to use
     */
    public GamePlayScreen(Stage primaryStage, GameMap gameMap) {
        this.primaryStage = primaryStage;
        this.gameController = new GameController(gameMap);
        initializeUI();
        setupGameController();
    }

    /**
     * Initialize the UI components.
     */
    private void initializeUI() {
        setStyle("-fx-background-color: #222222;");
        setPadding(new Insets(10));

        // Create the top panel with game info
        HBox topPanel = createTopPanel();
        setTop(topPanel);

        // Create the game canvas
        gameCanvas = new Canvas(800, 600);
        setCenter(gameCanvas);

        // Create the bottom panel with controls
        HBox bottomPanel = createBottomPanel();
        setBottom(bottomPanel);
    }

    /**
     * Create the top panel with game information.
     *
     * @return the top panel
     */
    private HBox createTopPanel() {
        HBox panel = new HBox(20);
        panel.setPadding(new Insets(10));
        panel.setAlignment(Pos.CENTER);
        panel.setStyle("-fx-background-color: #333333; -fx-border-color: #444444; -fx-border-width: 0 0 1 0;");

        goldLabel = new Label("Gold: 0");
        goldLabel.setTextFill(Color.GOLD);
        
        livesLabel = new Label("Lives: 0");
        livesLabel.setTextFill(Color.RED);
        
        waveLabel = new Label("Wave: 0");
        waveLabel.setTextFill(Color.WHITE);
        
        panel.getChildren().addAll(goldLabel, livesLabel, waveLabel);
        
        return panel;
    }

    /**
     * Create the bottom panel with game controls.
     *
     * @return the bottom panel
     */
    private HBox createBottomPanel() {
        HBox panel = new HBox(20);
        panel.setPadding(new Insets(10));
        panel.setAlignment(Pos.CENTER);
        panel.setStyle("-fx-background-color: #333333; -fx-border-color: #444444; -fx-border-width: 1 0 0 0;");

        Button startWaveButton = new Button("Start Wave");
        startWaveButton.setOnAction(e -> gameController.startNextWave());
        
        Button saveButton = new Button("Save Game");
        saveButton.setOnAction(e -> saveGame());
        
        Button loadButton = new Button("Load Game");
        loadButton.setOnAction(e -> loadGame());
        
        Button mainMenuButton = new Button("Main Menu");
        mainMenuButton.setOnAction(e -> returnToMainMenu());
        
        panel.getChildren().addAll(startWaveButton, saveButton, loadButton, mainMenuButton);
        
        return panel;
    }

    /**
     * Set up the game controller and start the game loop.
     */
    private void setupGameController() {
        // Update the UI to reflect the controller's state
        updateUI();
        
        // Set up wave completion listener
        gameController.setOnWaveCompletedListener((waveNumber, goldBonus) -> 
            Platform.runLater(() -> {
                showAlert("Wave Completed", "Wave " + waveNumber + " completed!\nGold bonus: " + goldBonus);
                updateUI();
            })
        );
        
        // Start the game loop
        startGameLoop();
    }

    /**
     * Start the game animation loop.
     */
    private void startGameLoop() {
        if (gameLoop != null) {
            gameLoop.stop();
        }
        
        lastUpdateTime = System.nanoTime();
        
        gameLoop = new AnimationTimer() {
            @Override
            public void handle(long now) {
                // Update game
                // Note: game controller already handles its own update in its game loop
                
                // Render game
                GraphicsContext gc = gameCanvas.getGraphicsContext2D();
                gc.clearRect(0, 0, gameCanvas.getWidth(), gameCanvas.getHeight());
                gameController.render(gc);
                
                // Update UI
                if (now - lastUpdateTime > 1_000_000_000) { // Update UI once per second
                    lastUpdateTime = now;
                    updateUI();
                }
                
                // Check for game over
                if (gameController.isGameOver()) {
                    stop();
                    showGameOverScreen();
                }
            }
        };
        
        gameLoop.start();
        gameController.startGame();
    }
    
    /**
     * Update the UI to reflect the current game state.
     */
    private void updateUI() {
        Platform.runLater(() -> {
            goldLabel.setText("Gold: " + gameController.getPlayerGold());
            livesLabel.setText("Lives: " + gameController.getPlayerLives());
            waveLabel.setText("Wave: " + gameController.getCurrentWave());
        });
    }
    
    /**
     * Show the game over screen.
     */
    private void showGameOverScreen() {
        Platform.runLater(() -> {
            showAlert("Game Over", "Game over! You survived " + gameController.getCurrentWave() + " waves.");
            returnToMainMenu();
        });
    }

    /**
     * Return to the main menu.
     */
    private void returnToMainMenu() {
        if (gameLoop != null) {
            gameLoop.stop();
        }
        
        gameController.stopGame();
        
        MainMenuScreen mainMenu = new MainMenuScreen(primaryStage);
        Scene scene = new Scene(mainMenu, 800, 600);
        primaryStage.setScene(scene);
    }
    
    /**
     * Save the current game state to a file.
     */
    private void saveGame() {
        FileChooser fileChooser = new FileChooser();
        fileChooser.setTitle("Save Game");
        fileChooser.setInitialDirectory(new File(System.getProperty("user.home")));
        fileChooser.getExtensionFilters().add(new FileChooser.ExtensionFilter("Save Files", "*.save"));
        
        // Pause the game while saving
        boolean wasRunning = false;
        if (gameLoop != null) {
            gameLoop.stop();
            wasRunning = true;
        }
        
        File selectedFile = fileChooser.showSaveDialog(getScene().getWindow());
        if (selectedFile != null) {
            try (ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream(selectedFile))) {
                oos.writeObject(gameController);
                showAlert("Game Saved", "Game saved successfully to " + selectedFile.getName());
            } catch (Exception e) {
                e.printStackTrace();
                showAlert("Error", "Failed to save game: " + e.getMessage());
            }
        }
        
        // Resume the game if it was running before
        if (wasRunning) {
            gameLoop.start();
        }
    }

    /**
     * Load a game from a file.
     */
    private void loadGame() {
        FileChooser fileChooser = new FileChooser();
        fileChooser.setTitle("Load Game");
        fileChooser.setInitialDirectory(new File(System.getProperty("user.home")));
        fileChooser.getExtensionFilters().add(new FileChooser.ExtensionFilter("Save Files", "*.save"));
        
        File selectedFile = fileChooser.showOpenDialog(getScene().getWindow());
        if (selectedFile != null) {
            try (ObjectInputStream ois = new ObjectInputStream(new FileInputStream(selectedFile))) {
                GameController loadedController = (GameController) ois.readObject();
                
                // Reinitialize the controller to fix graphical issues with entities
                loadedController.reinitializeAfterLoad();
                
                gameController = loadedController;
                
                // Update UI references to the loaded controller
                setupGameController();
                
                // Start the game animation
                startGameLoop();
                
                showAlert("Game Loaded", "Game loaded successfully from " + selectedFile.getName());
            } catch (Exception e) {
                e.printStackTrace();
                showAlert("Error", "Failed to load game: " + e.getMessage());
            }
        }
    }
    
    /**
     * Show an alert dialog.
     * 
     * @param title the title of the alert
     * @param message the message to display
     */
    private void showAlert(String title, String message) {
        Platform.runLater(() -> {
            Alert alert = new Alert(Alert.AlertType.INFORMATION);
            alert.setTitle(title);
            alert.setHeaderText(null);
            alert.setContentText(message);
            alert.showAndWait();
        });
    }
} 